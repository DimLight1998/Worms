# 软件工程大作业设计文档

---

## 游戏介绍

这个大作业在游戏流程上尽量模仿原版制作，画面的风格模仿Terraria。游戏采用多人回合对战模式，支持2~4人进行游戏，规则与百战天虫相似。玩家在设置完成之后进入游戏，轮流移动、相互攻击、破坏与建造地形。一旦某阵营的所有人物全部死亡即出局。最后存活下来的阵营获胜。

---

## 功能说明

游戏的功能和原版差不多。下面列出一些注意事项和创新功能介绍。

### 注意事项

- **结束界面**：结束界面在开始新一局游戏的时候使用的是上一局游戏的设置；
- **基础地图**：完成了三幅风格不同而且随机生成地形逻辑不同的游戏地图；
- **不同阵营**：阵营数目是可选的，每个阵营的人物数目也是可选的；
- **武器操作**：按F键切换为武器模式时人物无法移动，同时默认的武器为空武器，按R更换武器；
- **其他界面**：选择地图、阵营数目和人物数目时进行点击即可，如果不点击直接开始会使用默认设置；
- **多种武器**：完成的四个武器分别是
  - 导弹：碰到地形后触发爆炸，默认的弹药数是无限的；
  - 手榴弹：一段时间后爆炸，这段时间内使用和人物相同的运动逻辑，默认的弹药数是无限的；
  - 粘性炸弹：和手雷相似，不同的是在运动过程中一旦碰见障碍物会黏在上面直至爆炸，每阵营三个；
  - 矿用炸药：只能原地放置同时不受风力影响，伤害极高而且威力很大，默认每个阵营只有一个；
- **补给系统**：棕色箱子补血量，蓝色箱子补弹药，黄色箱子补建材；
- **时间系统**：时间显示在窗口左上角，黄色表示现在可以观察无法移动，绿色表示现在可以自由活动，红色表示现在只能进行移动（人物发射完武器之后的撤退时间）。

### 创新功能介绍

- **建造系统**：每个阵营都有一定的建材数目用来进行建造，建造方法是用鼠标左击地图上的空的地方。如果阵营有剩余的建材而且左击的地方满足一定条件的话就可以成功进行建造，该区域将出现一个小方块。需要满足的条件是目标区域和已有地形块邻接而且在人物的建造范围之内。合理地使用该系统可以为自己建造掩体或创造制高点或将敌人围困住，从而提高游戏的可玩性。建材的获取来自游戏开始时的补给，以及破环现有地形时有一定概率出现可供收集的地形块。
- **镜头移动/跟随系统**：在游戏进行时游戏镜头会随着人物而移动，在中央区域会始终以人物为中心，在边缘区域会靠紧地图边缘。同时玩家可以使用方向键四处查看，这个时候镜头不会跟随人物，但是如果玩家又开始操控人物的话镜头会立即以人物居中且锁定。同时切换人物时镜头平滑移动直至将要切换到的人物居中。
- **自然的地形贴图**：地形的贴图不是简单的从一张图片上直接复制的，而是每一个小地形块都有自己的独立的贴图，同时这个独立的贴图是从一类独立贴图中随机选取的。这个独立的贴图会随着该地形块四周的地形情况而改变，因此随着游戏的进行，地形的显示会不断发生变化，例如地形贴图边缘黑色界限总是和周围的相连：![QQ截图20161213215010](C:\Users\hp\Desktop\QQ截图20161213215010.png)
- **小地图**：因为游戏的地图比窗口更大所以开了一个小地图，而且这个小地图是即时更新的。但是因为~~赶工~~绘制的原因没解决闪烁问题。可以按M键将小地图关掉。
- **可选阵营和每个阵营的人物数量**

---

## 流程图

![IMG_20161213_203849](C:\Users\hp\Desktop\IMG_20161213_203849.jpg)![IMG_20161213_211203](C:\Users\hp\Desktop\IMG_20161213_211203.jpg)

---

## 遇到的问题及解决方案

遇到的最大的问题是**地形的绘制问题**。因为我一开始用的是正方形地块来模拟地形，使用的是绘制矩形的方法来完成绘制。后来准备统一画风，所以搞出了地形贴图和地形边缘动态变化的机制。但是这个时候如果使用绘制贴图的方法来绘制地形的话游戏会变得非常非常卡。一开始我以为是这是小地形块太多了导致的，但是如果我把绘制贴图改成绘制矩形之后程序几乎不卡，所以断定是绘制贴图太慢导致的。至于解决方案，我一开始希望通过改变计时器间隔来让程序流畅，但是并没有什么用；然后我想到地形的一个性质：总是处于除背景图片外的最底层同时不需要频繁更新。按着这个思路我准备每次需要更新的时候就把地形给绘制一遍，然后把这张图片用Bitmap的形式保存下来，以后就直接读取这个Bitmap就行了。虽然想法很简单但是查资料用了很久，而且几乎做不出效果。最后在助教的帮助下搞定了代码。原理是这样的：声明一个全局的位图句柄，然后用一个布尔变量来控制地形是否需要重新绘制。如果要重绘的话就画出来然后存到一个临时HDC里面，再把这个HDC的内容存到位图里面。以后如果发现地图不需要重新绘制就直接从位图读取地形图片，改完之后就很流畅了。但是其实问题还是没解决，我在进行测试的时候发现每次地图更新，都会检测到程序多占用了20M的内存，刚好是那张位图的大小。这个说明我没有回收内存，但是因为回收内存必须得写在Create的后面，但是这样干的话就会导致刚存好的位图马上消失。这里我纠结了很久，然后想到可以在Create之前Delete一次（第一次Create前不Delete，最后一次结束的时候Delete一次），这样保证了内存不会泄露，而且程序画出了正确的东西。这个时候问题就被解决了。

---

## 心得体会

### 写工程的时候要先列好框架再具体实现，最后再往里面加功能

我觉得这个是挺重要的。我写的时候事先就没怎么规划，很多功能的写的顺序都是很随意的。结果到最后我才开始写AI，然后因为自己地形的实现已经定死了，不是很好把AI加进去，所以就没有完成AI这个点。而且框架清楚的好处是整个程序让人看上去就能看清楚，这点我看助教的框架是很清楚的，但是我自己的代码结构就有点复杂了。

### 一个功能完成起来比看上去要简单

我在写大作业的过程中有时候想往里面加一个功能，然后分析的时候觉得自己写出来要花很长时间，估计只能写个阉割版的了。但是开始写的时候就发现其实没那么复杂，写着写着就把完整的功能实现了，而且花的时间远低于自己的预期。然后从整个大作业来讲的话，一开始拿到大作业的时候觉得自己只能完成一小部分的选做内容，但是慢慢做着就发现自己能搞定大部分的内容，整个流程并没有想的那么复杂。

### 做事要尽可能严谨

不严谨会出一些Bug，而且非常难察觉。我记得很深的是一次添加资源的时候有张图片就是显示不出来，不管我怎么调都没用，而且在代码里面查来查去都没发现问题。折腾了大概两个小时都没进展，最后发现居然是因为文件名前面有个空格我没打。就是因为这个空格耗了我两小时的时间。然后还有一次是一个函数在执行完之后总是会把一个和这个函数完全没联系的变量给改掉。我找了半天问题发现是自己的数组访问越界了，但是VS并没有报错。这些事情都是平时严谨一点就可以避免的，如果可以做到严谨的话可能平时会耗多一点的时间，但是可以避免很多莫名其妙的错误。